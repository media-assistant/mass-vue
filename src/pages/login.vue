<template>
    <Section
        class="flex flex-col h-screen justify-center"
    >
        <div class="-mt-24">
            <h1
                class="text-black dark:text-white text-3xl font-bold text-center mb-10"
            >
                Media Assistant
            </h1>
            <div class="flex mb-6">
                <label
                    class="p-4 inline-block bg-gray-100 rounded-l-lg text-black font-semibold w-28"
                    for="email"
                >Email</label>
                <input
                    id="email"
                    v-model="email"
                    class="flex-auto bg-gray-100 rounded-r-lg focus:outline-none"
                    type="text"
                    name="email"
                    placeholder="hi@example.com"
                >
            </div>
            <div class="flex">
                <label
                    class="p-4 inline-block bg-gray-100 rounded-l-lg text-black font-semibold w-28"
                    for="password"
                >Password</label>
                <input
                    id="password"
                    v-model="password"
                    class="flex-auto bg-gray-100 rounded-r-lg focus:outline-none"
                    type="password"
                    name="password"
                    placeholder="super-secure-password"
                >
            </div>
        </div>
    </Section>
    <FixedFooter>
        <div
            v-if="error !== ''"
            class="px-2 py-1 leading-normal text-red-700 bg-red-100 rounded-md mb-2"
            role="alert"
        >
            <p>
                <strong>Error logging you in: </strong>
                {{ error }}
            </p>
        </div>
        <CTAButton
            :disabled="email === '' || password === ''"
            :is-loading="busy === true"
            @click="login"
        >
            Login
        </CTAButton>
        <!-- <div class="text-center">
            Forgot password?
        </div> -->
    </FixedFooter>
</template>

<script lang="ts" setup>
import { onMounted, ref } from 'vue';
import { HOME, TOKEN } from '../plugins/fetch/routes/mass-api';

import { json, post } from '../plugins/fetch/index';
import { useAuth } from '../compositions/auth';

import CTAButton from '../components/CTAButton.vue';
import Section from '../components/Section.vue';
import FixedFooter from '../components/FixedFooter.vue';

import type { TokenResponse } from '../types/mass-api';
import { FetchError } from '../plugins/fetch/error';
import router from '../plugins/router';
import { useSession } from '../compositions/session';

const email = ref('');
const password = ref('');
const error = ref('');
const busy = ref(false);

const { token } = useAuth();

const login = async (): Promise<void> => {
    try {
        const data = await post<TokenResponse>(TOKEN, json({
            email: email.value,
            password: password.value,
        }));

        token.value = data.token;

        void router.replace(HOME);
    } catch (fetch_error) {
        if (fetch_error instanceof FetchError) {
            error.value = fetch_error.message;
        } else {
            throw fetch_error;
        }
    }
};

onMounted(async () => {
    if (token.value) {
        const { fetchSessionData } = useSession();

        try {
            await fetchSessionData();

            void router.replace(HOME);
        } catch (fetch_error) {
            // Nothing
        }
    }
});
</script>